const contractAddress = "0xc2442eaa18f2bdcdc2c00070738fb65702383692"; // Replace with your address

const abi = [
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "offerId",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "buyEnergy",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "offerId",
                "type": "uint256"
            }
        ],
        "name": "cancelOffer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "offerId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "address",
                "name": "buyer",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "totalPrice",
                "type": "uint256"
            }
        ],
        "name": "EnergyBought",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "offerId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "address",
                "name": "seller",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "totalEnergy",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "pricePerUnit",
                "type": "uint256"
            }
        ],
        "name": "EnergyListed",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "offerId",
                "type": "uint256"
            }
        ],
        "name": "EnergyOfferCancelled",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "totalEnergy",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "pricePerUnit",
                "type": "uint256"
            }
        ],
        "name": "listEnergy",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "offerId",
                "type": "uint256"
            }
        ],
        "name": "getOffer",
        "outputs": [
            {
                "internalType": "address",
                "name": "seller",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "totalEnergy",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "availableEnergy",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "pricePerUnit",
                "type": "uint256"
            },
            {
                "internalType": "bool",
                "name": "isActive",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "offerCount",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "offers",
        "outputs": [
            {
                "internalType": "address",
                "name": "seller",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "totalEnergy",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "availableEnergy",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "pricePerUnit",
                "type": "uint256"
            },
            {
                "internalType": "bool",
                "name": "isActive",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

let provider, signer, contract, userAddress;

async function connect() {
  if (!window.ethereum) return alert("Install MetaMask.");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  document.getElementById("wallet").textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
  contract = new ethers.Contract(contractAddress, abi, signer);
}

async function listEnergy() {
  try {
    const energy = document.getElementById("energyInput").value;
    const price = document.getElementById("priceInput").value;
    if (!energy || !price || energy <= 0 || price <= 0)
      return alert("Energy and price must be > 0");

    const tx = await contract.listEnergy(energy, price);
    await tx.wait();
    alert("Energy listed!");
  } catch (err) {
    console.error("ListEnergy Error:", err.message || err);
    alert("Transaction failed: " + (err.message || err));
  }
}

async function buyEnergy() {
  try {
    const offerId = Number(document.getElementById("buyOfferId").value);
    const amount = Number(document.getElementById("buyAmount").value);

    if (!offerId || !amount || amount <= 0) {
      return alert("Enter a valid offer ID and amount > 0.");
    }

    const offer = await contract.getOffer(offerId);
    const seller = offer[0];
    const totalEnergy = offer[1];
    const availableEnergy = offer[2];
    const pricePerUnit = offer[3];
    const isActive = offer[4];

    if (!isActive) {
      return alert(`Offer #${offerId} is no longer active.`);
    }

    if (amount > availableEnergy) {
      return alert(`Offer only has ${availableEnergy} kWh available. You requested ${amount}.`);
    }

    const totalPrice = amount * pricePerUnit;

    const tx = await contract.buyEnergy(offerId, amount, { value: totalPrice });
    await tx.wait();

    alert(`âœ… Bought ${amount} kWh from offer #${offerId}.`);
  } catch (err) {
    console.error("Buy Energy Error:", err);
    alert("Transaction failed: " + (err.data?.message || err.message));
  }
}


async function cancelOffer() {
  const offerId = document.getElementById("cancelId").value;
  if (!offerId) return alert("Enter an offer ID.");
  const tx = await contract.cancelOffer(offerId);
  await tx.wait();
  alert("Offer cancelled!");
}

async function getOfferDetails() {
  const offerId = document.getElementById("detailId").value;
  if (!offerId) return alert("Enter an offer ID.");
 
  try {
    const offer = await contract.getOffer(offerId);
    const [seller, total, available, price, active] = offer;

    const detailsBox = document.getElementById("detailsBox");

    if (!active) {
      detailsBox.textContent = "No offer available.";
    } else {
      detailsBox.textContent = `Seller: ${seller}
Total: ${total} kWh
Available: ${available} kWh
Price/Unit: ${price} wei
Active: ${active}`;
    }
  } catch (err) {
    console.error("Get Offer Details Error:", err);
    alert("Failed to fetch offer details: " + (err.message || err));
  }
}

